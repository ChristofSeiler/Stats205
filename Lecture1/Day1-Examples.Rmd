---
title: "Day 1: Examples"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Rank-Based Method

### Question

Does sending kids to school improve social awareness over home schooling?

### Experiment

Eight pairs of identical twins who are of nursery school age. For each pair, one is randomly selected to attend nursery school while the other remains at home. At the end of the study period, all 16 children are given the same social awareness test.

```{r}
school = c(82,69,73,43,58,56,76,65)
home = c(63,42,74,37,51,43,80,62)
```

### Statistic

For each pair, the response of interest is the difference in the twins’ scores, (Twin at School − Twin at Home).

```{r}
response = school - home
response
```

We use signed-rank Wilcoxon procedure to find out.
The usual statistic is the sum of the ranks of positive items:

```{r}
wplus = sum((response>0)*rank(response))
wplus
```

or equivalently:

```{r}
n = length(response)
w = sum(sign(response)*rank(response))
wplus = 0.5*w + n*(n+1)/4
wplus
```

### Computations

Is this due to chance?

Luckily, the probability mass function for our test statistics is known (under the null hypothesis of equal median):

```{r}
x = seq(0,n*(n+1)/2,1)
colors = rep("white",length(x))
colors[wplus] = "red"
barplot(dsignrank(x,n),names.arg = x,main = paste0("dsignrank(x, n = ", n, ")"),col = colors)
```

and using the cumulative distribution function $F_{W^+}(w^+-1,n)$ of our test statistics:

```{r}
plot(x,psignrank(x, n = n),type = "s",main = paste0("psignrank(x, n = ", n, ")"))
abline(v=wplus,col = "red",lwd = 4)
abline(h=psignrank(wplus,n),col = "blue",lwd = 4)
```

we can find the $p$-value using $P_{H_0}(W^+ \ge w^+) = 1 - F_{W^+}(w^+ - 1,n)$:

```{r}
pvalue = 1-psignrank(wplus-1,n,lower.tail = TRUE)
pvalue
```

<!-- Not the same, why? -->
<!-- There is also an R base implementation of this test: -->

<!-- ```{r} -->
<!-- wilcox.test(response,alternative="greater") -->
<!-- ``` -->

### Conclusion

We can reject the null hypthesis at significance level $\alpha = 0.05$ in favor of the alternative that sending kids to school improves their social awareness.

## Bootstrap

### Question

Does small dose of aspirin prevent heart attacks in healthy middle-aged man?

### Experiment

A randomized double-blind study was designed to collect data. The subjects were randomly assigned to the aspirin and placebo groups. Doctors and subjects didn't know whether they treated or received aspirin or placebo substance.

```{r}
labels = c("nattacks","nsubjects")
aspirin = c(104,11037)
placebo = c(189,11034)
data = data.frame(aspirin,placebo)
rownames(data) = labels
data
```

### Statistic

Ratio of the rates:

```{r}
rate = function(v) v[1]/v[2]
theta.hat = rate(data$aspirin)/rate(data$placebo)
theta.hat
```

This means that in this sample aspirin-takers only have 55% as many heart attacks as placebo-takers.

### Computations

Is this due to chance? Or can this results be reproduced in other similar experiments? 
Let's use the bootstrap method to find out:

```{r}
population.one = c( rep(1,data["nattacks","aspirin"]), 
                    rep(0,data["nsubjects","aspirin"]-data["nattacks","aspirin"]) )
population.two = c( rep(1,data["nattacks","placebo"]), 
                    rep(0,data["nsubjects","placebo"]-data["nattacks","placebo"]) )

draw.bootstrap.sample = function() {
  boot.pop.one = sample(population.one,replace = TRUE)
  boot.pop.two = sample(population.two,replace = TRUE)
  rate.one = sum(boot.pop.one)/length(boot.pop.one)
  rate.two = sum(boot.pop.two)/length(boot.pop.two)
  return(rate.one/rate.two)
}
```

and now simulate:

```{r}
nrep = 10000
theta.boot = replicate(nrep,draw.bootstrap.sample())
hist(theta.boot,breaks=100)

# sample estimate
abline(v=theta.hat,col = "red",lwd = 4)

# bootstrap confidence interval
confidence.lower = sort(theta.boot)[nrep*.025]
confidence.upper = sort(theta.boot)[nrep*.975]
abline(v=c(confidence.lower,confidence.upper),col = "blue",lwd = 4)
```

### Conclusion

We can conclude that aspirin was found to be significantly beneficial for preventing heart attacks.
